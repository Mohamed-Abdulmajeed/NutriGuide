<section class="meal-page" *ngIf="meal; else loading">

    <div class="meal-container">

        <!-- IMAGE HEADER -->
        <div class="meal-header">
            <img [src]="meal.image ? meal.image + '?l=en&w=1920&h=1080&q=95&auto=format&fit=crop' : meal.image"
                alt="{{ meal.name }}" class="meal-img" loading="eager" decoding="async">

            <div class="header-overlay">
                <div class="overlay-left">
                    <button class="action-btn" aria-label="رجوع" (click)="goBack()">
                        <i class="fa-solid fa-arrow-right-long"></i>
                    </button>
                </div>
                <div class="overlay-right">
                    <button class="action-btn fav-btn text-danger" aria-label="مفضلة" (click)="toggleFavorite()"
                        [attr.aria-pressed]="isFavorite">
                        <i [ngClass]="{ 'fa-heart': true, 'fa-solid': isFavorite, 'fa-regular': !isFavorite }"
                            [class.heart-filled]="isFavorite"></i>
                    </button>
                    <button class="action-btn" aria-label="مشاركة" (click)="shareMeal()">
                        <i class="fa-solid fa-share-nodes"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Meal Info -->
        <div class="meal-info">
            <h1 class="meal-name">{{ meal.name }}</h1>
        </div>


        <!-- MACRO CARDS BELOW IMAGE -->
        <div class="macros">
            <article class="macro-card protein">
                <span class="macro-icon"><i class="fa-solid fa-drumstick-bite"></i></span>
                <div>
                    <div class="macro-value">{{ meal.protein ?? 0 }} <small>ج</small></div>
                    <div class="macro-label">بروتين</div>
                </div>
            </article>
            <article class="macro-card carbs">
                <span class="macro-icon"><i class="fa-solid fa-bread-slice"></i></span>
                <div>
                    <div class="macro-value">{{ meal.carbs ?? 0 }} <small>ج</small></div>
                    <div class="macro-label">كربوهيدرات</div>
                </div>
            </article>
            <article class="macro-card fat">
                <span class="macro-icon"><i class="fa-solid fa-bacon"></i></span>
                <div>
                    <div class="macro-value">{{ meal.fat ?? 0 }} <small>ج</small></div>
                    <div class="macro-label">دهون</div>
                </div>
            </article>
            <article class="macro-card calories">
                <span class="macro-icon"><i class="fa-solid fa-fire"></i></span>
                <div>
                    <div class="macro-value">{{ meal.calories ?? 0 }}</div>
                    <div class="macro-label">سعرات</div>
                </div>
            </article>
        </div>

        <!-- Ingredients -->
        <div class="meal-section">
            <h4><i class="fas fa-list"></i> المكونات</h4>
            <ul class="ingredients-list">
                <li *ngFor="let ing of meal.ingredientsDTO">
                    <i class="fas fa-check-circle ingredient-icon"></i>
                    <span>{{ ing.name }} — {{ ing.amount }} {{ ing.unit }}</span>
                </li>
            </ul>
        </div>

        <!-- Preparation -->
        <div class="meal-section">
            <h4><i class="fas fa-utensils"></i> طريقة التحضير</h4>

            <ol class="preparation-steps">
                <li *ngFor="let step of meal.preparation.split('.')">
                    {{ step }}
                </li>
            </ol>
        </div>

        <!-- HEALTH BENEFITS -->
        <div class="section card benefits-card">
            <h2>الفوائد الصحية</h2>
            <p *ngIf="meal.healthBenefits; else noBenefits" class="benefits-text">{{ meal.healthBenefits }}</p>
            <ng-template #noBenefits>
                <p class="muted">لا توجد فوائد مسجلة لهذه الوجبة.</p>
            </ng-template>
        </div>

    </div>

</section>

<ng-template #loading>
    <div class="loading">جارٍ تحميل البيانات...</div>
</ng-template>

<!-- Confirmation Modal for Favorite Delete -->
<div id="confirmModalMeal" class="confirm-overlay hidden">
    <div class="confirm-box">
        <h3>هل تريد حذف الوجبة من المفضلة؟</h3>
        <div class="modal-actions">
            <button class="confirm-yes" (click)="confirmDelete()">حذف</button>
            <button class="confirm-no" (click)="closeConfirm()">إلغاء</button>
        </div>
    </div>
</div>